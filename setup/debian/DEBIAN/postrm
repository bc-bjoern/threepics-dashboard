#!/bin/bash
set -e  # Sofort bei Fehler abbrechen

# Optionales Logfile
LOGFILE="/var/log/threepics-postrm.log"
exec >> "$LOGFILE" 2>&1
echo "ðŸ§¹ postrm started at $(date)"

# --- 1. Dienste deaktivieren ---
echo "ðŸ”Œ Disabling systemd services ..."
systemctl disable threepics-backend.service || true
systemctl disable threepics-frontend.service || true
systemctl disable getty@tty1.service || true
systemctl stop threepics-backend.service || true
systemctl stop threepics-frontend.service || true
systemctl daemon-reload || true
systemctl stop getty@tty1.service || true
systemctl daemon-reload || true

# --- 2. Cronjobs entfernen ---
echo "ðŸ“† Removing cronjobs ..."
crontab -u threepics -l 2>/dev/null | grep -v 'threepics-dashboard' | crontab -u threepics - || true

# --- 3. Benutzerverzeichnis entfernen ---
echo "ðŸ—‘ Removing /opt/threepics ..."
rm -rf /opt/threepics

# --- 4. Benutzer entfernen ---
echo "ðŸ‘¤ Removing user 'threepics' ..."
if id "threepics" &>/dev/null; then
  userdel -r threepics || true
fi

# --- 5. Sudoers-Datei entfernen ---
echo "ðŸ§¾ Removing sudoers config ..."
rm -f /etc/sudoers.d/threepics

# --- 6. Logdatei bereinigen ---
echo "ðŸ§¹ Cleaning up log ..."
rm -f /var/log/threepics-postinst.log

echo "âœ… postrm completed at $(date)"
exit 0
